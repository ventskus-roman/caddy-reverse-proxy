:{$PORT} {
  # ---- PRELIGHT (OPTIONS) для CORS ----
  @options method OPTIONS
  handle @options {
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Headers "*"
    header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
    respond 204
  }

  # ---- Прокси на основной API kie.ai ----
  handle_path /kie/* {
    reverse_proxy https://api.kie.ai {
      header_up -Authorization
      header_up Authorization "Bearer {$KIE_API_KEY}"
      header_up Host api.kie.ai
    }
  }

  # ---- Прокси на File Upload API kie.ai ----
  handle_path /upload/* {
    reverse_proxy https://kieai.redpandaai.co {
      header_up -Authorization
      header_up Authorization "Bearer {$KIE_API_KEY}"
      header_up Host kieai.redpandaai.co
    }
  }

  # ---- На всё остальное 404 (без поддиректив) ----
  respond 404
}

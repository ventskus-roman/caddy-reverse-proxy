:{$PORT} {

  ##############################
  # CORS для браузеров / WebView
  ##############################

  @options method OPTIONS
  respond @options 204
  header Access-Control-Allow-Origin "*" 
  header Access-Control-Allow-Headers "*" 
  header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"

  ##############################
  # Прокси на основной API KIE
  ##############################

  handle_path /kie/* {
    reverse_proxy https://api.kie.ai {
      header_up -Authorization
      header_up Authorization "Bearer {$KIE_API_KEY}"
      header_up Host api.kie.ai
    }
  }

  ##############################
  # Прокси на File Upload API
  ##############################

  handle_path /upload/* {
    reverse_proxy https://kieai.redpandaai.co {
      header_up -Authorization
      header_up Authorization "Bearer {$KIE_API_KEY}"
      header_up Host kieai.redpandaai.co
    }
  }

  ##############################
  # Заглушка на прочие пути
  ##############################
  respond "Not found" 404
}

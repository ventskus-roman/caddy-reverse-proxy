:{$PORT} {

  # Preflight-мэчер
  @options method OPTIONS

  # Обрабатываем preflight: сначала ставим заголовки, потом просто 204
  handle @options {
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Headers "*"
    header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
    respond 204
  }

  # Основной API kie.ai
  handle_path /kie/* {
    reverse_proxy https://api.kie.ai {
      header_up -Authorization
      header_up Authorization "Bearer {$KIE_API_KEY}"
      header_up Host api.kie.ai
    }
  }

  # Upload-хост kie.ai
  handle_path /upload/* {
    reverse_proxy https://kieai.redpandaai.co {
      header_up -Authorization
      header_up Authorization "Bearer {$KIE_API_KEY}"
      header_up Host kieai.redpandaai.co
    }
  }

  respond "Not found" 404
}

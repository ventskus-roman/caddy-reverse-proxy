:{$PORT} {
  # (Опционально) CORS для WebView/веб-клиента
  @preflight method OPTIONS
  respond @preflight 204 {
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Headers "*"
    header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
  }
  header {
    Access-Control-Allow-Origin "*"
  }

  # Прокси на основной API kie.ai:
  handle_path /kie/* {
    reverse_proxy https://api.kie.ai {
      # Снимаем клиентский Authorization и подставляем ваш
      header_up -Authorization
      header_up Authorization "Bearer {$KIE_API_KEY}"
      header_up Host api.kie.ai
    }
  }

  # Прокси на File Upload API (у KIE другой хост):
  handle_path /upload/* {
    reverse_proxy https://kieai.redpandaai.co {
      header_up -Authorization
      header_up Authorization "Bearer {$KIE_API_KEY}"
      header_up Host kieai.redpandaai.co
    }
  }

  respond "Not found" 404
}
